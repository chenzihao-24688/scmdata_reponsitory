DECLARE
v_sql CLOB;
BEGIN
  v_sql := '{DECLARE
  V_JUGNUM   NUMBER(4);
  V_CATEJUG  NUMBER(4);
  V_PCATEJUG NUMBER(4);
  V_SCATEJUG NUMBER(4);
  V_CATE     VARCHAR2(32);
  V_PCATE    VARCHAR2(32);
  V_SCATE    VARCHAR2(32);
  V_SUPPCODE VARCHAR2(32);
  V_ORDIDS   VARCHAR2(2048);
  V_COMPID   VARCHAR2(32) := %DEFAULT_COMPANY_ID%;
  V_GOOIDS   VARCHAR2(2048);
  RET_SQL    CLOB;
BEGIN
  SELECT LISTAGG(A.ORDER_ID, '','') || '','',
         LISTAGG(B.GOO_ID, '','') || '','',
         MAX(A.SUPPLIER_CODE),
         COUNT(DISTINCT A.SUPPLIER_CODE)
    INTO V_ORDIDS, V_GOOIDS, V_SUPPCODE, V_JUGNUM
    FROM (SELECT ORDER_ID, ORDER_CODE, SUPPLIER_CODE, COMPANY_ID
            FROM SCMDATA.T_ORDERED
           WHERE ORDER_ID IN (@SELECTION)
             AND COMPANY_ID = V_COMPID) A
   INNER JOIN SCMDATA.T_ORDERS B
      ON A.ORDER_CODE = B.ORDER_ID
     AND A.COMPANY_ID = B.COMPANY_ID;

  IF V_JUGNUM > 1 THEN
    RAISE_APPLICATION_ERROR(-20002,
                            ''所选订单供应商/商品“行业分类+生产类别+产品子类”不一致，无法批量指定！'');
  END IF;

  SELECT COUNT(DISTINCT CATEGORY),
         COUNT(DISTINCT PRODUCT_CATE),
         COUNT(DISTINCT SAMLL_CATEGORY),
         MAX(CATEGORY),
         MAX(PRODUCT_CATE),
         MAX(SAMLL_CATEGORY)
    INTO V_CATEJUG, V_PCATEJUG, V_SCATEJUG, V_CATE, V_PCATE, V_SCATE
    FROM SCMDATA.T_COMMODITY_INFO
   WHERE REGEXP_COUNT(V_GOOIDS, GOO_ID || '','') > 0
     AND COMPANY_ID = V_COMPID;

  IF V_CATEJUG > 1 OR V_PCATEJUG > 1 OR V_SCATEJUG > 1 THEN
    RAISE_APPLICATION_ERROR(-20002,
                            ''所选订单供应商/商品“行业分类+生产类别+产品子类”不一致，无法批量指定！'');
  END IF;

  RET_SQL := ''SELECT DISTINCT ''''''||V_ORDIDS||'''''' ORDER_ID, FACTORY_CODE, SUPPLIER_COMPANY_NAME PRODUCT_FACTORY
                FROM (SELECT SUPPLIER_CODE FACTORY_CODE, SUPPLIER_COMPANY_NAME
                        FROM SCMDATA.T_SUPPLIER_INFO
                       WHERE SUPPLIER_CODE = ''''''||V_SUPPCODE||''''''
                         AND COMPANY_ID = ''''''||V_COMPID||''''''
                      UNION ALL
                      SELECT B.FACTORY_CODE,C.SUPPLIER_COMPANY_NAME 
  FROM (SELECT SUPPLIER_INFO_ID, SUPPLIER_CODE, COMPANY_ID, SUPPLIER_COMPANY_NAME
          FROM SCMDATA.T_SUPPLIER_INFO
         WHERE PAUSE IN (0, 2)) A
  LEFT JOIN SCMDATA.T_COOP_FACTORY B
    ON A.SUPPLIER_INFO_ID = B.SUPPLIER_INFO_ID
   AND A.COMPANY_ID = B.COMPANY_ID
   AND B.PAUSE = 0
  LEFT JOIN SCMDATA.T_SUPPLIER_INFO C
    ON B.FAC_SUP_INFO_ID = C.SUPPLIER_INFO_ID
   AND B.COMPANY_ID = C.COMPANY_ID
   AND C.SUPPLIER_CODE IS NOT NULL
   AND C.PAUSE IN (0, 2)
  LEFT JOIN SCMDATA.T_COOP_SCOPE D
    ON C.SUPPLIER_INFO_ID = D.SUPPLIER_INFO_ID
   AND C.COMPANY_ID = D.COMPANY_ID
   AND D.PAUSE = 0
  LEFT JOIN SCMDATA.SYS_GROUP_DICT E
    ON D.COOP_CLASSIFICATION = E.GROUP_DICT_VALUE
   AND C.COOPERATION_TYPE = E.GROUP_DICT_TYPE
 WHERE A.SUPPLIER_CODE = ''''''||V_SUPPCODE||''''''
   AND A.COMPANY_ID = ''''''||V_COMPID||''''''
   AND (A.SUPPLIER_CODE = C.SUPPLIER_CODE OR INSTR(C.COOPERATION_MODEL,''''OF'''')>0)
   AND INSTR(D.COOP_CLASSIFICATION , ''''''||V_CATE||'''''')>0
   AND INSTR(D.COOP_PRODUCT_CATE , ''''''||V_PCATE||'''''')>0
   AND INSTR(D.COOP_SUBCATEGORY , ''''''||V_SCATE||'''''')>0)'';

  @StrResult := RET_SQL;
END;}';
UPDATE bw3.sys_action t SET t.action_sql = v_sql WHERE t.element_id = 'action_a_order_102';
END;
/
